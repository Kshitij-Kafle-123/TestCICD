name: Build-Test-AutoMerge to express-merge

on:
  pull_request:
    branches:
      - express-merge
    types: [opened, synchronize, reopened, ready_for_review, closed]
  workflow_dispatch:
  push:
    branches:
      - express-merge

permissions:
  contents: write       
  pull-requests: write
  actions: read
  checks: read
  security-events: write
  packages: write

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore StringCalculatorSolution.sln

      - name: Build solution
        run: dotnet build StringCalculatorSolution.sln --configuration Release --no-restore

      - name: Run Unit Tests
        run: dotnet test StringCalculatorSolution.sln --configuration Release --no-build --verbosity normal

  scan-dependencies:
    name: Security & Dependency Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OSV Scan
        run: |
          # Run OSV scanner and save output
          osv-scanner ./ > scan-output.log || true

      - name: Upload scan output
        uses: actions/upload-artifact@v4
        with:
          name: scan-output
          path: scan-output.log

  scan-result-check:
    name: Check scan results
    runs-on: ubuntu-latest
    needs: scan-dependencies
    steps:
      - name: Download scan output
        uses: actions/download-artifact@v4
        with:
          name: scan-output
          path: .

      - name: Fail if vulnerabilities found
        run: |
          if grep -q "VULNERABILITY" scan-output.log; then
            echo "Vulnerabilities found. Failing workflow."
            exit 1
          else
            echo "No vulnerabilities found."
          fi

  auto-merge:
    name: Auto Merge if Clean
    runs-on: ubuntu-latest
    needs: [build-and-test, scan-result-check]
    if: success()
    outputs:
      merged: ${{ steps.merge.outputs.merged }}
    steps:
      - name: Attempt to merge pull request via API
        id: merge
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull_request payload available.');
              core.setOutput('merged', 'false');
              return;
            }
            try {
              const res = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash'
              });
              core.info(`Merge response: ${JSON.stringify(res.data)}`);
              core.setOutput('merged', res.data.merged ? 'true' : 'false');
            } catch (err) {
              core.info(`Merge failed: ${err.message}`);
              core.setOutput('merged', 'false');
            }

      - name: Confirm merge (log)
        run: |
          if [ "${{ steps.merge.outputs.merged }}" = "true" ]; then
            printf 'PR #%s merged into express-merge.\n' "${{ github.event.pull_request.number }}"
          else
            echo "PR was not merged by this job. Skipping deploy steps that require a merge."
          fi

  deploy-to-dockerhub:
    name: Deploy to Docker Hub
    runs-on: ubuntu-latest
    needs: [auto-merge]
    if: ${{ github.event_name == 'push' || needs.auto-merge.outputs.merged == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/testcicd
          tags: |
            type=sha,format=short
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-release:
    name: Create GitHub Release (draft)
    runs-on: ubuntu-latest
    needs: deploy-to-dockerhub
    steps:
      - name: Create draft release
        if: ${{ github.event_name == 'push' || needs.auto-merge.outputs.merged == 'true' || github.event.pull_request.merged == true }}
        uses: actions/create-release@v1
        with:
          tag_name: release-${{ github.sha }}
          release_name: Release ${{ github.sha }}
          body: |
            Draft release created for commit ${{ github.sha }}.
            This release is generated automatically after a merge to `express-merge`.
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
